{% extends 'base_course.html' %}

{% if alerts %}
  <script>
    $(function() {
      cbShowAlert("{{ alerts | js_string }}");
    });
  </script>
{% endif %}

{% block subtitle %}
  {# I18N: Title of the webpage. #}
  - {{ gettext('Student Roster') }}
{% endblock subtitle %}

{% block assets %}
  {{ super() }}
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" type="text/css" href="assets/lib/lessons/tipped.css" />
  <script src="assets/lib/lessons/tipped.js"></script>
<!--  BUG?  Why can't I load these from resources directory. 404 error ??????  -->
<!--   <link rel="stylesheet" type="text/css" href="{{resources_path}}/css/tipped.css" /> -->
<!--   <script src="{{resources_path}}/js/tipped.js"></script> -->
  <script>
    // Script for adding hovers to some elements on the page.
    $(document).ready(function() {
      Tipped.create('.help', function(element) {
    var help = $(element).data('id');
    return documentation[help];
        }, {
          cache: false,
            position: 'topleft'
            });
    });
  
    var documentation = { 
      "quiz" : "For a given lesson, quiz scores gives the ratio of the number of correct quiz answers over the total number of quizzes in the lesson. N/A means no quizzes were attempted.",
      "lesson" : "For a given unit, lesson progress is either complete (100 %), in-progress (50 %) or not started (0 %).",
      "unit": "Unit progress is the percentage of lessons completed in that unit. Lessons that do not contain quizzes are considered complete when visited.",
      "add/remove": "This button will let you add or remove students from your course.",
      "dashboard": "The dashboard provides a detailed breakdown of a student's progress and performance.",
      "unitselect": "Choose an option here to see student performance for a particular unit.",
      "lessonselect": "After choosing a unit option choose an option here to see student performance for a particular lesson.",
    };
  </script>
  <script type="text/javascript">
    function get_quiz_ratio(student, unit, lesson) {
      var ratio = "N/A";
      if (student['scores'][unit]) {
        if (student['scores'][unit][lesson]) {
          ratio = student['scores'][unit][lesson]['ratio'];
        }
      }
      return ratio;
    }

    // Performs a lookup in the studentsJs table for each student
    function update_section_stats(unit_id, lesson_id) {
      for (var i=0; i < studentsJs.length; i++) {
         var student = studentsJs[i];
         var unit_cell = document.getElementById('student-unit-progress-cell-' + (i+1)); // table cells are 1-indexed
         var lesson_cell = document.getElementById('student-lesson-progress-cell-' + (i+1)); // table cells are 1-indexed
         var quizzes_cell = document.getElementById('student-quizzes-cell-' + (i+1)); // table cells are 1-indexed
         var quiz_ratio = get_quiz_ratio(student, unit_id,lesson_id);
         quizzes_cell.innerHTML = quiz_ratio;
         if (unit_id != 'course_completion') {
           unit_cell.innerHTML = student['progress_dict']['unit_completion'][unit_id]
           if (lesson_id != "NA")
             lesson_cell.innerHTML = student['progress_dict']['lessons_progress'][unit_id][lesson_id] / 2 * 100
           else
             lesson_cell.innerHTML = "N/A";
         } else {
           unit_cell.innerHTML = student['progress_dict']['course_progress']
           lesson_cell.innerHTML = "N/A";
         }
      }
    }

    $(function() {
      // Handles updating the lesson select options and completion values
      $('.unit-select').change(function() {
        $('#questions-container').empty();
        var newOptions = [];
        if (this.value != 'course_completion') {
          document.getElementById('course-unit-progress-heading').innerHTML = 'Unit Progress %';
          var lessons = lessonsObject[this.value];
          for (var i =0; i < lessons.length; i++) {
            newOptions.push({
              key: lessons[i].lesson_id,
              value: lessons[i].title
            });
          }
        } else {
          document.getElementById('course-unit-progress-heading').innerHTML = 'Course Progress %';
          newOptions.push({
            key: 'NA',
            value: 'N/A'
          });
        }
        var lessonSelect = $(".lesson-select");
          lessonSelect.empty(); // remove old options
          $.each(newOptions, function(value,key) {
            lessonSelect.append($("<option></option>")
              .attr("value", key.key).text(key.value));
          });

        // Update the stats for this page
        var sel = document.getElementById('lesson-select-widget');
        var lesson_id = sel.options[sel.selectedIndex].value;
        update_section_stats(this.value, lesson_id);


         //defined in popup.js
//         RebuildCompletionColumn(window.students, this, $('.lesson-select'));

         if ($($('.lesson-select')).val() !== 'NA') {
//           var lessonScores = retrieveLessonScores(window.scores, $(this).val(), $($('.lesson-select')).val());
//           var activityTable = new ActivityTable(lessonScores);
//           activityTable.buildTable($(this).val(), $($('.lesson-select')).val(),
//             $($('.unit-select option:selected')).text(),
//             $($('.lesson-select option:selected')).text()).appendTo('#questions-container');
         }
      });
    });
    $(function() {
      $('.lesson-select').change(function() {
        //defined in popup.js
//        RebuildCompletionColumn(window.students, $('.unit-select'), this);

        $('#questions-container').empty();
        if ($(this).val() !== 'NA') {
          var sel = document.getElementById('unit-select-widget');
          var unit_id = sel.options[sel.selectedIndex].value;
          update_section_stats(unit_id, this.value);
//          var lessonScores = retrieveLessonScores(window.scores, $($('.unit-select')).val(), $(this).val());
//          var activityTable = new ActivityTable(lessonScores);
//          activityTable.buildTable($($('.unit-select')).val(), $(this).val(), $($('.unit-select')).text(),
//            $($('.lesson-select option:selected')).text()).appendTo('#questions-container');
        }
      });
    });

    function rebuildLessonSelect(unitId) {
      var options = {};
    }
  </script>
{% endblock %}

{% block top_content %}
{% endblock %}

{% block main_content %}
{{ main_content }}
{% if lessons %}
  <script>
  var lessonsJson = '{{ lessons|safe }}';
  var lessonsObject = jQuery.parseJSON(lessonsJson);
  </script>
{% endif %}
{% if students %}
  <script>
  var studentsArray = '{{ students_json | safe  }}'; 
  var studentsJs = jQuery.parseJSON(studentsArray)
  </script>
{% endif %}


{% if not disabled %}
<div id="gcb-main">
  <div class="gcb-article tab-content">
    <div class="gcb-aside">
      {% if section %}
       <h2>Student Roster for Course {{ section.name }}</h2>
       <table>
        <tbody>
         <tr>
          <td style="width:40%">
           <b>Teacher:  {{ section.teacher }} </b>
           <br /><b>Description: {{ section.description }}</b>
          </td>
          <td>
            You can manage student enrollment here, as well as view a summary of each student's progress at the course, unit, and lesson level. 
            Click here for <a target="_blank" href="https://docs.google.com/document/d/1XKGfVl_tQDGF0JPQFKh-PKiVKkn5Qu3LOZEJEzpjoaY">instructions and documentation</a>.
          </td>
         </tr>
        </tbody>
       </table>
      <hr>

        <table id="buttons-table"> 
         <tr>
          <td>
            <span class="hover help yui-wk-div" data-id="add/remove">
              <a href="teacher?action=edit_section&key={{ section.key }}" class="gcb-list__icon gcb-list__iconrowhover material-icons">
                 <button class="gcb-button" type="submit">Add / Remove Students</button>
              </a>
            </span>
          </td>
          <td>
           <span class="hover help yui-wk-div" data-id="unitselect"><label><b>Unit: </b></label></span>
           <select id="unit-select-widget"  class="unit-select">
              <option value="course_completion">Course</option>
              {% if units %} 
                {% for unit in units %}
                   {% if unit.type == 'U' %}
                         <option value="{{ unit.unit_id }}">{{ unit.title }}</option>
                   {% endif %}
                {% endfor %}
              {% endif %} 
          </td>
          <td>
           <span class="hover help yui-wk-div" data-id="lessonselect"><label style="margin-left: 10px;"><b>Lessons: </b></label></span>
           <select id="lesson-select-widget" class="lesson-select" style="min-width: 200px;">
              <option value="N/A">N/A</option>
           </select>
          </td>
         </tr>
        </table>

        {% if students %}
        <div class="gcb-list gcb-list--autostripe xsrf-token-holder"
             data-status-xsrf-token-teacher-dashboard="{{ status_xsrf_token }}">
         <h2>Students</h2>
         <table>
          <thead>
           <tr>
            <th class="gcb-list__cell--icon"></th>
            <th class="gcb-list__cell--icon">Name</th>
            <th class="gcb-list__cell--icon">Email</th>
            <th id="course-unit-progress-heading" class="gcb-list__cell--icon"><span class="hover help yui-wk-div" data-id="unit">Course Progress %</span></th>
            <th class="gcb-list__cell--icon"><span class="hover help yui-wk-div" data-id="lesson">Lesson Progress</span></th>
            <th class="gcb-list__cell--icon"><span class="hover help yui-wk-div" data-id="quiz">Quiz Progress</span></th>
           </tr>
          </thead>
          <tbody> 
          {% for student in students %}
            <tr>
             <td>
                <form id='view-dashboard-button-{{loop.index}}' action='edit_sections?action=add_section'  method='GET'>
                  <input type="hidden" name="action" value="add_section">
                  <span class="hover help yui-wk-div" data-id="dashboard">
                    <button class="gcb-button" type="submit">View Dashboard</button>
                  </span>
              </form>
               </td>
             <td id="student-name-cell-{{loop.index}}">
               {{ student.name }}
             </td>
             <td id="student-email-cell'{{loop.index}}">
                {{ student.email }}
             </td>
             <td id="student-unit-progress-cell-{{loop.index}}">
                {{ student.progress_dict.course_progress }}
             </td>
             <td id="student-lesson-progress-cell-{{loop.index}}">
               N/A
             </td> 
             <td id="student-quizzes-cell-{{loop.index}}">
               N/A
             </td> 
            </tr>
           {% endfor %}
          </tbody>
         </table>
        {% else %}
           {# I18N: Shown if the list of students is empty. #}
           <p>{{ gettext('Currently, you do not have any students in this section.') }}</p>
        {% endif %}
      {% endif %}
    </div>
  </div>
  <div id="questions-container"></div>
</div>
{% else %}
{# I18N: Shown if the user is not a registered teacher. #}
<p>Only registered teachers have access to the Teacher Dashboard.
<br />Please contact an admin.
</p>
{% endif %}
{% endblock %}
