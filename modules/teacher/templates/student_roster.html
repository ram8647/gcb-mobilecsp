{% extends 'base_course.html' %}

{% if alerts %}
  <script>
    $(function() {
      cbShowAlert("{{ alerts | js_string }}");
    });
  </script>
{% endif %}

{% block subtitle %}
  {# I18N: Title of the webpage. #}
  - {{ gettext('Student Roster') }}
{% endblock subtitle %}

{% block assets %}
  {{ super() }}
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" type="text/css" href="assets/lib/lessons/tipped.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css">
  <link rel="stylesheet" type="text/css" href="assets/lib/lessons/question_preview.css" /> 
  <script type="text/javascript" src="assets/lib/lessons/modal-window.js"></script>
  <script src="assets/lib/lessons/tipped.js"></script>

<!--  BUG?  Why can't I load these from resources directory. 404 error ??????  -->
<!--   <link rel="stylesheet" type="text/css" href="{{resources_path}}/css/tipped.css" /> -->
<!--   <script src="{{resources_path}}/js/tipped.js"></script> -->
  <script>
    // Script for adding hovers to some elements on the page.
    $(document).ready(function() {
      Tipped.create('.help', function(element) {
    var help = $(element).data('id');
    return documentation[help];
        }, {
          cache: false,
            position: 'topleft'
            });
    });
  
    var documentation = { 
      "quiz" : "For a given lesson, quiz scores gives the ratio of the number of correct quiz answers over the total number of quizzes in the lesson. N/A means no quizzes were attempted.",
      "lesson" : "For a given unit, lesson progress is either complete (100 %), in-progress (50 %) or not started (0 %).",
      "unit": "Unit progress is the percentage of lessons completed in that unit. Lessons that do not contain quizzes are considered complete when visited.",
      "add/remove": "This button will let you add or remove students from your course.",
      "dashboard": "The dashboard provides a detailed breakdown of a student's progress and performance.",
      "unitselect": "Choose an option here to see student performance for a particular unit.",
      "lessonselect": "After choosing a unit option choose an option here to see student performance for a particular lesson.",
    };
  </script>
  <script>
    $(document).ready(function() {
        setUpModalWindow();
     });
  </script>
  <script type="text/javascript">
    /*
     *  Retrieve the quiz performance ratio for a given unit and lesson.
     *
     *  @param student reference to the student's data dict
     *  @param unit the unit's id
     *  @param lesson the lesson's id
     *  @return a ratio of the form '# correct / # quizzes'
     */
    function get_quiz_ratio(student, unit, lesson) {
      var ratio = "N/A";
      if (student['scores'][unit]) {
        if (student['scores'][unit][lesson]) {
          ratio = student['scores'][unit][lesson]['ratio'];
        }
      }
      return ratio;
    }

    /*
     * Fills in student performance and progress data for a given unit and lesson 
     *  by performing lookups in the studentJs data table.
     *
     *  @param unit_id the unit number
     *  @param lesson_id the lesson number
     *
     */
    function update_section_stats(unit_id, lesson_id) {
      for (var i=0; i < studentsJs.length; i++) {
         var student = studentsJs[i];
         var unit_cell = document.getElementById('student-unit-progress-cell-' + (i+1)); // table cells are 1-indexed
         var lesson_cell = document.getElementById('student-lesson-progress-cell-' + (i+1)); // table cells are 1-indexed
         var quizzes_cell = document.getElementById('student-quizzes-cell-' + (i+1)); // table cells are 1-indexed
         var quiz_ratio = get_quiz_ratio(student, unit_id,lesson_id);
         quizzes_cell.innerHTML = quiz_ratio;
         if (unit_id != 'course_completion') {
           unit_cell.innerHTML = student['progress_dict']['unit_completion'][unit_id]
           if (lesson_id != "NA")
             lesson_cell.innerHTML = student['progress_dict']['lessons_progress'][unit_id][lesson_id] / 2 * 100
           else
             lesson_cell.innerHTML = "N/A";
         } else {
           unit_cell.innerHTML = student['progress_dict']['course_progress']
           lesson_cell.innerHTML = "N/A";
         }
      }
    }

    /*
     * Handles clicks on the unit selection widget, updating the student's completion values
     *   for the selected unit and filling in the lesson selection widget.
     */
    $(function() {
      $('.unit-select').change(function() {
//        $('#questions-container').empty();
        var newOptions = [];
        if (this.value != 'course_completion') {
          document.getElementById('course-unit-progress-heading').innerHTML = 'Unit Progress %';
          var lessons = lessonsObject[this.value];
          for (var i =0; i < lessons.length; i++) {
            newOptions.push({
              key: lessons[i].lesson_id,
              value: lessons[i].title
            });
          }
        } else {
          document.getElementById('course-unit-progress-heading').innerHTML = 'Course Progress %';
          newOptions.push({
            key: 'NA',
            value: 'N/A'
          });
        }
        var lessonSelect = $(".lesson-select");
          lessonSelect.empty(); // remove old options
          $.each(newOptions, function(value,key) {
            lessonSelect.append($("<option></option>")
              .attr("value", key.key).text(key.value));
          });

        // Update the stats for this page
        var sel = document.getElementById('lesson-select-widget');
        var lesson_id = sel.options[sel.selectedIndex].value;
        update_section_stats(this.value, lesson_id);

      });
    });

    /*
     * Handles clicks on the lesson selection widget, updating the lesson's stats.
     */
    $(function() {
      $('.lesson-select').change(function() {
//        $('#questions-container').empty();
        if ($(this).val() !== 'NA') {
          var sel = document.getElementById('unit-select-widget');
          var unit_id = sel.options[sel.selectedIndex].value;
          update_section_stats(unit_id, this.value);
          get_questions_table(unit_id, this.value);
        }
      });
    });

    function calc_number_of_answer_columns(unit_id, lesson_id) {
      var maxlen = 0;
      var scores_obj;
      for (var i = 0; i < studentsJs.length; i++) {
        var scores = studentsJs[i]['scores'];
        if (scores[unit_id] && scores[unit_id][lesson_id]) {
          scores = studentsJs[i].scores[unit_id][lesson_id];
          var len = Object.keys(scores).length;
          if (len  > maxlen) 
            maxlen = len;
            scores_obj = scores;
        }
      }
      return [scores_obj, maxlen - 1];  // One of the keys is 'ratio', not an answer choice
    }

    // Creates a table of all the questions in a given lesson.
    // With a break down by answers given by students
    function get_questions_table(unit_id, lesson_id) {
      // Get and clear the table
      var table = document.getElementById('questions-table');
      while (table.firstChild) {
        table.removeChild(table.firstChild);
      }

//      var num_columns = calc_number_of_answer_columns(unit_id, lesson_id);
      var result = calc_number_of_answer_columns(unit_id, lesson_id);
      var scores_obj = result[0];
      var num_columns = result[1];
      if (num_columns <= 0) 
        return;

      // Row 0 is for the headings
      var row = table.insertRow(0);
      row.insertCell(0).innerHTML = '<b>Questions</b>';

//      alert('num cols = ' + num_columns);
      for (var i = 0; i < num_columns; i++) {
        row.insertCell(i+1).innerHTML = 'Ans ' + (i+1);
      }
      var j = 1;  // Table row index
      for (var i in scores_obj) {
        if (i != 'ratio') {
          var id = scores_obj[i]['question_id'];
//          table.insertRow(j++).insertCell(0).innerHTML = "<div style=color:blue; quid='" + id + "' class='zmdi zmdi-eye'> Q" + id + "</div>";

          table.insertRow(j++).insertCell(0).innerHTML = "<div style='color:blue;' >"  +
             "<a target='_blank' class=zmdi zmdi eye'" + 
             " href=https://mobilecsp-201608.appspot.com/mobilecsp/unit?unit=" + unit_id + "&lesson=" + lesson_id + "> Q " + id + "</a></div>";
        }
      }

      // Create handlers for each question
<!--       var els = document.getElementsByClassName("zmdi zmdi-eye"); -->
<!--       for (var i = 0; i < els.length; i++) { -->
<!--         els[i].onclick = function() {  // Opens a modal iframe to display the question, code in modal-window.js -->
<!--           openModal(); -->
<!--           var params = { -->
<!--              action: 'question_preview', -->
<!--              quid: this.getAttribute('quid') -->
<!--           }; -->
<!--           $('#question-preview').html($('<iframe />').attr( -->
<!--              {id: 'question-preview', src: 'dashboard?' + $.param(params)})).show(); -->
<!--         }; -->
<!--       } // for -->

<!--       var cell = row.insertCell(0); -->
<!--       row.insertCell(0).innerHTML = <b>Student</b> -->

<!--       cell.innerHTML = "Questions"; -->

<!--       for (var i= 0; i < attempts_array.length; i++) {  // Queston Ids -->
<!--         var cell = row.insertCell(i+1); -->
<!--         var id = attempts_array[i][0]; -->

<!--         // Make a unique class name for each clickable icon -- icns from material design, see link above -->
<!--         var md_class_name = "zmdi zmdi-" + id + " zmdi-eye"; -->
<!--         cell.innerHTML = "<div style='color:blue'; class='" + md_class_name + "'> Q" + (i+1) + "</div>"; -->
<!--         var els = document.getElementsByClassName(md_class_name); -->
<!--         els[0].setAttribute('quid', id); -->
<!--         els[0].onclick = function() {  // Open a modal iframe to display the question -->
<!--           openModal(); -->
<!--           var params = { -->
<!--              action: 'question_preview', -->
<!--              quid: this.getAttribute('quid') -->
<!--           }; -->
<!--           $('#question-preview').html($('<iframe />').attr( -->
<!--              {id: 'question-preview', src: 'dashboard?' + $.param(params)})).show(); -->
<!--         }; -->
<!--       } -->

<!--       // Row 1 is for the number of attempts -->
<!--       row = table.insertRow(1); -->
<!--       cell = row.insertCell(0); -->
<!--       cell.innerHTML = "Attempts"; -->
<!--       for (var i= 0; i < attempts_array.length; i++) { -->
<!--         var cell = row.insertCell(i+1); -->
<!--         cell.innerHTML = attempts_array[i][1]; -->
<!--       } -->

<!--       // Row 2 is for the student's score -->
<!--       row = table.insertRow(2); -->
<!--       cell = row.insertCell(0); -->
<!--       cell.innerHTML = "Scores"; -->
<!--       for (var i= 0; i < attempts_array.length; i++) { -->
<!--         var cell = row.insertCell(i+1); -->
<!--         cell.innerHTML = attempts_array[i][2]; -->
<!--       } -->
      return table;
   } // def
    

  </script>
{% endblock %}

{% block top_content %}
{% endblock %}

{% block main_content %}
{{ main_content }}

{% if lessons %}
  <script>
  var lessonsJson = '{{ lessons|safe }}';
  var lessonsObject = jQuery.parseJSON(lessonsJson);
  </script>
{% endif %}
{% if all_lessons %}
  <script>
  var all_lessons = '{{ all_lessons }}';
  </script>
{% endif %}
{% if students %}
  <script>
  var studentsArray = '{{ students_json | safe  }}'; 
  var studentsJs = jQuery.parseJSON(studentsArray);
  window.studentsJs = studentsJs;
  </script>
{% endif %}


{% if not disabled %}
<div id="gcb-main">
  <div class="gcb-article tab-content">
    <div class="gcb-aside">
      {% if section %}
       <h2>Student Roster for Course {{ section.name }}</h2>
       <table>
        <tbody>
         <tr>
          <td style="width:40%">
           <b>Teacher:  {{ section.teacher }} </b>
           <br /><b>Description: {{ section.description }}</b>
          </td>
          <td>
            You can manage student enrollment here, as well as view a summary of each student's progress at the course, unit, and lesson level. 
            Click here for <a target="_blank" href="https://docs.google.com/document/d/1XKGfVl_tQDGF0JPQFKh-PKiVKkn5Qu3LOZEJEzpjoaY">instructions and documentation</a>.
          </td>
         </tr>
        </tbody>
       </table>
      <hr>

        <table id="buttons-table"> 
         <tr>
          <td>
            <span class="hover help yui-wk-div" data-id="add/remove">
              <a href="teacher?action=edit_section&key={{ section.key }}" class="gcb-list__icon gcb-list__iconrowhover material-icons">
                 <button class="gcb-button" type="submit">Add / Remove Students</button>
              </a>
            </span>
          </td>
          <td>
           <span class="hover help yui-wk-div" data-id="unitselect"><label><b>Unit: </b></label></span>
           <select id="unit-select-widget"  class="unit-select">
              <option value="course_completion">Course</option>
              {% if units %} 
                {% for unit in units %}
                   {% if unit.type == 'U' %}
                         <option value="{{ unit.unit_id }}">{{ unit.title }}</option>
                   {% endif %}
                {% endfor %}
              {% endif %} 
          </td>
          <td>
           <span class="hover help yui-wk-div" data-id="lessonselect"><label style="margin-left: 10px;"><b>Lessons: </b></label></span>
            <select id="lesson-select-widget" class="lesson-select" style="min-width: 200px;">
              <option value="N/A">N/A</option>
           </select>
          </td>
         </tr>
        </table>

        {% if students %}
        <div class="gcb-list gcb-list--autostripe xsrf-token-holder"
             data-status-xsrf-token-teacher-dashboard="{{ status_xsrf_token }}">
         <h2>Students</h2>
         <table>
          <thead>
           <tr>
            <th class="gcb-list__cell--icon"></th>
            <th class="gcb-list__cell--icon">Name</th>
            <th class="gcb-list__cell--icon">Email</th>
            <th id="course-unit-progress-heading" class="gcb-list__cell--icon"><span class="hover help yui-wk-div" data-id="unit">Course Progress %</span></th>
            <th class="gcb-list__cell--icon"><span class="hover help yui-wk-div" data-id="lesson">Lesson Progress</span></th>
            <th class="gcb-list__cell--icon"><span class="hover help yui-wk-div" data-id="quiz">Quiz Progress</span></th>
           </tr>
          </thead>
          <tbody> 
          {% for student in students %}
            <tr>
             <td>
              <a href="teacher?action=student_dashboard&student={{ student.email }}" class="gcb-list__icon gcb-list__iconrowhover material-icons">
                 <button class="gcb-button" type="submit">View Dashboard</button>
              </a>
<!--                 <form id='view-dashboard-button-{{loop.index}}' action='edit_sections?action=add_section'  method='GET'> -->
<!--                   <input type="hidden" name="action" value="add_section"> -->
<!--                   <span class="hover help yui-wk-div" data-id="dashboard"> -->
<!--                     <button class="gcb-button" type="submit">View Dashboard</button> -->
<!--                   </span> -->
<!--               </form> -->
               </td>
             <td id="student-name-cell-{{loop.index}}">
               {{ student.name }}
             </td>
             <td id="student-email-cell'{{loop.index}}">
                {{ student.email }}
             </td>
             <td id="student-unit-progress-cell-{{loop.index}}">
                {{ student.progress_dict.course_progress }}
             </td>
             <td id="student-lesson-progress-cell-{{loop.index}}">
               N/A
             </td> 
             <td id="student-quizzes-cell-{{loop.index}}">
               N/A
             </td> 
            </tr>
           {% endfor %}
          </tbody>
         </table>
        {% else %}
           {# I18N: Shown if the list of students is empty. #}
           <p>{{ gettext('Currently, you do not have any students in this section.') }}</p>
        {% endif %}
      {% endif %}
    </div>
  </div>

  <div id="questions-container">
   <table id="questions-table"></table>
  </div>

    <div id="modal-window" style="display: none;">
      <div id="question-background"></div>
      <div id="question-container">
        <a class="gcb-button question-close-button">X</a>
        <div id="question-preview"><iframe  id="question-preview" /></div>
      </div>
    </div>

</div>

{% else %}
{# I18N: Shown if the user is not a registered teacher. #}
<p>Only registered teachers have access to the Teacher Dashboard.
<br />Please contact an admin.
</p>
{% endif %}
{% endblock %}
